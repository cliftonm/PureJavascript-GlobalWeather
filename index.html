<!-- file:///C:/projects/PureJavascript/GlobalWeather/index.html -->

<!--

    Non-Angular, .NET Core version of:
    https://www.codeproject.com/Articles/1274513/Angular-7-with-NET-Core-2-2-Global-Weather-Part-1
    https://www.codeproject.com/Articles/1276248/Angular-7-with-NET-Core-2-2-Global-Weather-Part-2

    What I like to see in my Javascript code:

    // I don't want to see any harcoded strings in the Javascript except for Constants here!
    // The only exception is single character strings used for url path and parameter manipulation.
    // Callback methods are archaic -- async/await is really nice here.
    // Use template literals (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals) instead of str1 + 'xyz' + str2

-->

<style>
    .frame {
        padding-top: 20px;
        padding-left: 20px;
    }

    .label {
        width: 100px;
        display: inline-block;
    }
    
    .vspacer10 {
        padding-top: 10px;
    }

    .vspacer20 {
        padding-top: 20px;
    }

    .error {
        color: red;
        visibility: hidden;
    }

    .dayForecast {
        padding-top: 10px;
    }

    .small-font {
        font-size: small;
    }

    .hidden {
        visibility: hidden;
    }

    .colDayOfWeek {
        width:100px;
    }

    .colIcon {
        width:150px;
    }

    .fixed-layout {
        table-layout: fixed;
    }
</style>

<html>
    <body>
        <div class='frame'>
            <div>
                <label class='label'>Country:</label>
                <select id='countries'></select>
                <label class='error' id='countryRequired'>Please select a country.</label>
            </div>
            <div class='vspacer10'>
                <label class='label'>Admin Area:</label>
                <select id='adminAreas'></select>
                <label class='error' id='areaRequired'>Please select an area.</label>
            </div>
            <div class='vspacer10'>
                <label class='label'>City / Town:</label>
                <input id='city'></input>
                <label class='error' id='cityRequired'>Please enter a city.</label>
                <label class='error' id='cityNotFound'>City not found!</label>
                <label class='error' id='cityMoreThanOne'>More than one city found!</label>
            </div>
            <div id='forecastContainer'>
            </div>
        </div>

        <div class='hidden' id='forecastTemplate'>
            <table class='vspacer20 fixed-layout'>
                <tbody>
                    <tr>
                        <td class='colDayOfWeek'>
                            <label id='dow{n}'></label>
                        </td>
                        <td class='colIcon'>
                            <img id='icon{n}'/>
                        </td>
                        <td>
                            <label id='descr{n}'></label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class='small-font'>High:</label>
                            <label class='small-font' id='maxTemp{n}'></label>
                            </br>
                            <label class='small-font'>Low:</label>
                            <label class='small-font' id='minTemp{n}'></label>
                        </td>
                        <td>
                            <label class='small-font'>Wind:</label>
                            <label class='small-font' id='windSpeed{n}'></label>
                            <label class='small-font' id='windDir{n}'></label>
                            </br>
                            <label class='small-font'>Gusts:</label>
                            <label class='small-font' id='gustSpeed{n}'></label>
                            <label class='small-font' id='gustDir{n}'></label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>

<script>
    class Cookies {
        // functions modified from https://www.w3schools.com/js/js_cookies.asp
        // Also see: // https://github.com/js-cookie/js-cookie/blob/master/src/js.cookie.js
        // Chrome doesn't save cookies from local pages (from file system): https://stackoverflow.com/questions/8105135/cannot-set-cookies-in-javascript
        static put(name, value, expdays = 7) {
            let d = new Date();
            d.setTime(d.getTime() + (expdays * 24 * 60 * 60 * 1000));
            document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
        }        

        static get(name) {
            let decodedCookie = decodeURIComponent(document.cookie);
            let cookies = decodedCookie.split(';');
            let mappedCookies = cookies.map(c=> { return {name:c.split('=')[0], value:c.split('=')[1]}; });
            let filteredCookies = mappedCookies.filter(c => {return c.name == name; });
            let value = filteredCookies.length == 1 ? filteredCookies[0] : String.empty;

            return value;
        }
    }

    // Use HTML Web Storage because cookies don't work from local pages (file system)
    class LocalStore {
        static put(name, value) {
            window.localStorage.setItem(name, value);
        }

        static get (name) {
            return window.localStorage.getItem(name);
        }
    }

    class String {
        static get empty() { return ''; }
        static get emptyJSON() { return '[]'; }
        static get true() { return 'true'; }

        static isNullOrEmpty(str) { return str == null || str == ''; }

        static escapeRegExp(str) {
            return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
        }        

        static replaceAll(str, find, replace) {
            return str.replace(new RegExp(String.escapeRegExp(find), 'g'), replace);        
        }
    }

    class Constants {
        static get apiKey() { return 'dnn8EgPucAGLLpa7KVIxGRAtmvkdE4Y6'; }
        static get countriesUrl() { return 'http://dataservice.accuweather.com/locations/v1/Countries'; }
        static get adminAreasUrl() { return 'http://dataservice.accuweather.com/locations/v1/adminareas/'; }
        static get citySearchUrl() { return 'http://dataservice.accuweather.com/locations/v1/cities/{countryId}/{areaId}/search' }
        static get weatherFiveDayForecastUrl() { return 'http://dataservice.accuweather.com/forecasts/v1/daily/5day/'; }
        static get iconUrl() { return 'https://developer.accuweather.com/sites/default/files/'; }
        static get queryKey() { return 'q'; }
        static get details() {return 'details'; }
        static get apiKeyName() { return 'apikey'; }

        static get countryRequired() { return 'countryRequired'; }
        static get areaRequired() { return 'areaRequired'; }
        static get cityRequired() { return 'cityRequired'; }
        static get cityNotFound() { return 'cityNotFound'; }
        static get cityMoreThanOne() { return 'cityMoreThanOne'; }

        static get countryId() { return '{countryId}'; }
        static get areaId() { return '{areaId}'; }

        static get cookieCountry() {return 'gwcountry'; }
        static get cookieArea() { return 'gwarea'; }
        static get cookieCity() { return 'gwcity'; }
        static get cookieCityKey() { return 'gwcitykey'; }

        static get selectCountry() { return '--- Select Country ---'; }
        static get selectArea() { return '--- Select Area ---'; }

        static get visible() { return 'visible'; }
        static get hidden() { return 'hidden'; }

        static get elCountries() {return 'countries'; }
        static get elAdminAreas() { return 'adminAreas'; }
        static get elCity() { return 'city'; }

        static get restGET() { return 'GET'; }
    }

    function el(id) { return document.getElementById(id); }    

    function standardErrorHandler(err) {
        alert(err.statusText);
    }

    function get(api) {
        return new Promise(resolve => {
            let xhr = new XMLHttpRequest();

            xhr.onload = () => {
                resolve({json: JSON.parse(xhr.response), status: xhr.status});
            };

            xhr.onerror = () => { 
                resolve({json: JSON.parse(String.emptyJSON), status: xhr.status, statusText: xhr.statusText});

                if (xhr.statusText != String.empty) {
                    standardErrorHandler({status: xhr.status, statusText: xhr.statusText});
                }
            };

            xhr.open(Constants.restGET, api, true);
            xhr.send();
        });
    }

    function appendAppKey(url) {
        return `${url}?${Constants.apiKeyName}=${Constants.apiKey}`;
    }

    async function getCountries() {
        let url = appendAppKey(Constants.countriesUrl);
        let countryList = await get(url);
        showCountries(countryList.json);
    }

    async function getAdminAreas(locId) {
        let url = appendAppKey(`${Constants.adminAreasUrl}/${locId}`);
        let areaList = await get(url);
        showAdminAreas(areaList.json);
    }

    function addParam(url, paramName, paramValue) {
        url = `${url}&${paramName}=${paramValue}`;

        return url;
    }

    function verifyCities(json) {
        let key = undefined;

        if (json.length == 0) {
            showError(Constants.cityNotFound);
        } else if (json.length > 1) {
            showError(Constants.cityMoreThanOne);
        }
        else {
            key = json[0].Key;
        }

        return key;
    }

    function getCities(countryId, areaId, city) {
        let url = appendAppKey(Constants.citySearchUrl);
        url = addParam(url, Constants.queryKey, city);
        url = url.replace(Constants.countryId, countryId).replace(Constants.areaId, areaId);
        return get(url);
    }

    function clearDropdown(el) {
        el.innerHTML = String.empty;
    }

    function showError(elId, state = true) {
        el(elId).style.visibility = state ? Constants.visible : Constants.hidden;

        return !state;
    }

    function showCountries(json) {
        clearDropdown(el(Constants.elCountries));
        let countries = json.map(item => {return {name: item.EnglishName, id: item.ID};})
            .sort((a, b) => {return a.name < b.name ? -1 : 1});
        let elOptions = el(Constants.elCountries).options;
        elOptions[0] = new Option(Constants.selectCountry, String.empty);
        countries.map(item => { elOptions[elOptions.length] = new Option(item.name, item.id);});
    }

    function showAdminAreas(json) {
        clearDropdown(el(Constants.elAdminAreas));
        let areas = json.map(item => {return {name: item.EnglishName, id: item.ID};})
            .sort((a, b) => {return a.name < b.name ? -1 : 1});
        let elOptions = el(Constants.elAdminAreas).options;            
        elOptions[0] = new Option(Constants.selectArea, String.empty);
        areas.map(item => { elOptions[elOptions.length] = new Option(item.name, item.id);});
    }

    async function onCountrySelected() {
        showError(Constants.countryRequired, false);
        let id = el(Constants.elCountries).value;    
        LocalStore.put(Constants.cookieCountry, id);
        await getAdminAreas(id);
    }

    function onAdminAreaSelected() {
        showError(Constants.areaRequired, false);
        let id = el(Constants.elAdminAreas).value;
        LocalStore.put(Constants.cookieArea, id);
    }

    async function cityEntered() {
        let countryId = el(Constants.elCountries).value;
        let areaId = el(Constants.elAdminAreas).value;
        let city = el(Constants.elCity).value;
        LocalStore.put(Constants.cookieCity, city);
        let ok = true;

        // clear errors related to city being entered but not found or more than one found.
        showError(Constants.cityNotFound, false);
        showError(Constants.cityMoreThanOne, false);

        // Verify selections:
        ok &= showError(Constants.countryRequired, countryId == String.empty);
        ok &= showError(Constants.areaRequired, areaId == String.empty);
        ok &= showError(Constants.cityRequired, city == String.empty);

        if (ok) {
            showError(Constants.cityRequired, false);
            let cities = await getCities(countryId, areaId, city);
            let key = verifyCities(cities.json);

            if (key === undefined) {
                LocalStore.put(Constants.cookieCityKey, String.empty);
                clearForecast();
            } else {
                LocalStore.put(Constants.cookieCityKey, key);
                getWeather(key);
            }
        }
    }

    function onKey(keyCode, matchValue, callback) {
        if (keyCode == matchValue) {
            callback();
        }
    }

    function wireUpEvents() {
        el(Constants.elCountries).onchange = onCountrySelected;
        el(Constants.elAdminAreas).onchange = onAdminAreaSelected;
        el(Constants.elCity).onkeyup = (event) => onKey(event.keyCode, 13, cityEntered);
    }

    function clearForecast() {
        el('forecastContainer').innerHTML = String.empty;
    }

    function usePreviousSettings() {
        let countryId = LocalStore.get(Constants.cookieCountry);
        let areaId = LocalStore.get(Constants.cookieArea);
        let city = LocalStore.get(Constants.cookieCity);
        let cityKey = LocalStore.get(Constants.cookieCityKey);

        if (!String.isNullOrEmpty(city)) {
            el(Constants.elCity).value = city;
        }

        if (!String.isNullOrEmpty(countryId)) {
            el(Constants.elCountries).value = countryId;
            onCountrySelected().then(() =>
            {
                if (!String.isNullOrEmpty(areaId)) {
                    el(Constants.elAdminAreas).value = areaId;

                    if (!String.isNullOrEmpty(city)) {
                        cityEntered();
                    }
                }
            });
        }
    }

    async function getWeather(key) {
        let url = appendAppKey(`${Constants.weatherFiveDayForecastUrl}/${key}`);
        url = addParam(url, Constants.details, String.true);
        let forecast = await get(url);
        let dailyForecasts = forecast.json.DailyForecasts;
        clearForecast();

        dailyForecasts.forEach((forecast, idx) => {
            let date = forecast.Date;
            let dayOfWeek = new Date(date).toLocaleString('en-us', {  weekday: 'long' });
            let minTemp = forecast.Temperature.Minimum.Value + ' ' + forecast.Temperature.Minimum.Unit;
            let maxTemp = forecast.Temperature.Maximum.Value + ' ' + forecast.Temperature.Maximum.Unit;
            let icon = forecast.Day.Icon;
            let descr = forecast.Day.LongPhrase;
            let windSpeed = forecast.Day.Wind.Speed.Value + ' ' + forecast.Day.Wind.Speed.Unit;
            let windDirection = forecast.Day.Wind.Direction.Localized;
            let windGust = forecast.Day.WindGust.Speed.Value + ' ' + forecast.Day.WindGust.Speed.Unit;
            let windGustDirection = forecast.Day.WindGust.Direction.Localized;
            let rain = forecast.Day.Rain.Value + ' ' + forecast.Day.Rain.Unit;
            let snow = forecast.Day.Snow.Value + ' ' + forecast.Day.Snow.Unit;
            let ice = forecast.Day.Ice.Value + ' ' + forecast.Day.Ice.Unit;
            let formattedIcon = parseInt(icon).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
            let iconUrl = `${Constants.iconUrl}${formattedIcon}-s.png`;           // Ex: 01-s.png

            let elForecastTemplate = el('forecastTemplate');
            let elForecastContainer = el('forecastContainer');
            elForecastHtml = String.replaceAll(elForecastTemplate.innerHTML, '{n}', idx);
            el('forecastContainer').innerHTML += elForecastHtml;
            el(`dow${idx}`).innerHTML = dayOfWeek;
            el(`descr${idx}`).innerHTML = descr;
            el(`icon${idx}`).src = iconUrl;
            el(`minTemp${idx}`).innerHTML = minTemp;
            el(`maxTemp${idx}`).innerHTML = maxTemp;
            el(`windSpeed${idx}`).innerHTML = windSpeed;
            el(`windDir${idx}`).innerHTML = windDirection;
            el(`gustSpeed${idx}`).innerHTML = windGust;
            el(`gustDir${idx}`).innerHTML = windGustDirection;
        });
    }

    function initializeElements() {
        let elOptions = el(Constants.elAdminAreas).options;
        elOptions[0] = new Option(Constants.selectArea, String.empty);
    }

    (function initialize() {
        initializeElements();
        wireUpEvents();
        getCountries().then(usePreviousSettings);
    })();
    

</script>